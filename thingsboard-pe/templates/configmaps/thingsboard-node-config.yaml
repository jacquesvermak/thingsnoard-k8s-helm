{{- if .Values.thingsboard.node.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "thingsboard-pe.fullname" . }}-node-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "thingsboard-pe.labels" . | nindent 4 }}
    app.kubernetes.io/component: node-config
data:
  conf: |
    # Java Options
    export JAVA_OPTS="$JAVA_OPTS -Dplatform=deb -Dinstall.data_dir=/usr/share/thingsboard/data"
    export JAVA_OPTS="$JAVA_OPTS -Xlog:gc*,heap*,age*,safepoint=debug:file=/var/log/thingsboard/${TB_SERVICE_ID}-gc.log:time,uptime,level,tags:filecount=10,filesize=10M"
    export JAVA_OPTS="$JAVA_OPTS -XX:+IgnoreUnrecognizedVMOptions -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/thingsboard/heapdump.hprof"
    export JAVA_OPTS="$JAVA_OPTS -XX:-UseBiasedLocking -XX:+UseTLAB -XX:+ResizeTLAB -XX:+PerfDisableSharedMem -XX:+UseCondCardMark"
    export JAVA_OPTS="$JAVA_OPTS -XX:+ExitOnOutOfMemoryError -XX:+UseContainerSupport -XX:MaxRAMPercentage=80"
    export JAVA_OPTS="$JAVA_OPTS -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:InitiatingHeapOccupancyPercent=45 -XX:ConcGCThreads=4 -XX:ParallelGCThreads=8"
    export JAVA_OPTS="$JAVA_OPTS -XX:+UnlockExperimentalVMOptions -XX:+UseStringDeduplication -XX:+OptimizeStringConcat"
    export JAVA_OPTS="$JAVA_OPTS -XX:MaxMetaspaceSize=512m -XX:CompressedClassSpaceSize=256m"

    export LOG_FILENAME=thingsboard.out
    export LOADER_PATH=/usr/share/thingsboard/conf,/usr/share/thingsboard/extensions

    # Service & Metrics
    export TB_SERVICE_TYPE=monolith
    export METRICS_ENABLED=true
    export METRICS_EXPORT_PROMETHEUS_ENABLED=true
    export METRICS_EXPORT_PROMETHEUS_ENDPOINT=/actuator/prometheus
    export METRICS_EXPORT_PROMETHEUS_GC_METRICS_ENABLED=true
    export METRICS_EXPORT_PROMETHEUS_JVM_METRICS_ENABLED=true
    export METRICS_EXPORT_PROMETHEUS_SYSTEM_METRICS_ENABLED=true
    export MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=prometheus,health,info
    export MANAGEMENT_ENDPOINTS_WEB_BASE_PATH=/actuator
    export MANAGEMENT_SERVER_PORT=8080

    # Kafka / Queue
    export TB_QUEUE_TYPE=kafka
    export TB_QUEUE_KAFKA_PARTITIONS=10
    export TB_QUEUE_KAFKA_REPLICATION_FACTOR=1
    export TB_QUEUE_KAFKA_MAX_POLL_RECORDS=2000
    export TB_QUEUE_KAFKA_MAX_POLL_INTERVAL_MS=300000
    export TB_QUEUE_KAFKA_CONSUMER_THREADS=10
    export TB_QUEUE_KAFKA_BATCH_SIZE=1048576
    export TB_QUEUE_KAFKA_LINGER_MS=10
    export TB_QUEUE_KAFKA_FETCH_MIN_BYTES=131072
    export TB_QUEUE_KAFKA_FETCH_MAX_WAIT_MS=52428800
    export TB_QUEUE_KAFKA_BUFFER_MEMORY=67108864
    export TB_QUEUE_KAFKA_ACKS=1
    export TB_QUEUE_KAFKA_RETRIES=10
    export TB_QUEUE_KAFKA_REQUEST_TIMEOUT_MS=60000

    # Zookeeper & JS
    export ZOOKEEPER_ENABLED={{ .Values.zookeeper.enabled }}
    export ZOOKEEPER_URL={{ include "thingsboard-pe.fullname" . }}-zookeeper:2181
    export TB_KAFKA_SERVERS={{ include "thingsboard-pe.fullname" . }}-kafka:9092
    export JS_EVALUATOR=remote
    export TRANSPORT_TYPE=remote

    # HTTP & Cache
    export HTTP_LOG_CONTROLLER_ERROR_STACK_TRACE=false
    export CACHE_TYPE=redis
    export REDIS_TIMEOUT=10000
    export REDIS_HOST={{ include "thingsboard-pe.fullname" . }}-redis-master
    {{- if .Values.redis.auth.enabled }}
    export REDIS_PASSWORD={{ .Values.redis.auth.password }}
    {{- end }}

    # JWT & Timeouts
    export JWT_TOKEN_EXPIRATION_TIME=9000
    export JWT_REFRESH_TOKEN_EXPIRATION_TIME=604800
    export DEFAULT_INACTIVITY_TIMEOUT=600
    export DEFAULT_STATE_CHECK_INTERVAL=60

    # Transport & Stats
    export TB_QUEUE_STATS_ENABLED=false
    export TB_QUEUE_TRANSPORT_REQUEST_TIMEOUT={{ .Values.thingsboard.transports.coap.env.TB_QUEUE_REQUEST_TIMEOUT | default "120000" }}
    export TB_QUEUE_TRANSPORT_MAX_PENDING_REQUESTS=50000
    {{- if .Values.thingsboard.transports.coap.dtlsEnabled }}
    export COAP_DTLS_BIND_PORT={{ .Values.thingsboard.transports.coap.port }}
    export COAP_DTLS_ENABLED=true
    export COAP_DTLS_CREDENTIALS_TYPE=PEM
    export COAP_DTLS_PEM_CERT=/https-config/server.pem
    export COAP_DTLS_PEM_KEY=/https-config/server_key.pem
    {{- end }}
    export TB_TRANSPORT_SESSIONS_INACTIVITY_TIMEOUT=900000
    export TB_TRANSPORT_SESSIONS_REPORT_TIMEOUT=30000
    export TB_TRANSPORT_RATE_LIMITS_ENABLED=false

    # License Configuration
    export TB_LICENSE_SECRET={{ .Values.thingsboard.node.env.TB_LICENSE_SECRET | quote }}
    export TB_LICENSE_VALIDATION_ENABLED={{ .Values.thingsboard.node.env.TB_LICENSE_VALIDATION_ENABLED | quote }}
    export SWAGGER_ENABLED={{ .Values.thingsboard.node.env.SWAGGER_ENABLED | quote }}

  logback: |
    <!DOCTYPE configuration>
    <configuration scan="true" scanPeriod="10 seconds">

        <appender name="fileLogAppender"
                  class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>/var/log/thingsboard/${TB_SERVICE_ID}/thingsboard.log</file>
            <rollingPolicy
                    class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>/var/log/thingsboard/${TB_SERVICE_ID}/thingsboard.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
                <totalSizeCap>3GB</totalSizeCap>
            </rollingPolicy>
            <encoder>
                <pattern>%d{ISO8601} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>

        <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{ISO8601} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>

        <root level="INFO">
            <appender-ref ref="STDOUT"/>
        </root>
        <logger name="org.thingsboard.server" level="INFO" />
        <logger name="com.google.common.util.concurrent.AggregateFuture" level="WARN" />

    </configuration>

  thingsboard.conf: |
    export TB_LICENSE_VALIDATION_ENABLED={{ .Values.thingsboard.node.env.TB_LICENSE_VALIDATION_ENABLED | quote }}
    export TB_LICENSE_SECRET_KEY="{{ .Values.thingsboard.node.env.TB_LICENSE_SECRET }}"
    export TB_LICENSE_INSTANCE_DATA_FILE=/data/license.data
    export TB_LICENSE_CHECK_RATE_LIMIT_ENABLED=false
{{- end }}